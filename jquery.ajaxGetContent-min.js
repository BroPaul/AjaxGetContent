/*	
 *	jQuery AjaxGetContent 1.2

 *  Requires: jQuery BBQ, http://benalman.com/projects/jquery-bbq-plugin/
 *	
 *	More info at:
 *  www.implico.pl/lang-en/ajaxgetcontent_dynamic_ajax_website,7.html
 *	info@implico.pl
 *	
 *	Copyright (c) 2012 Implico Group
 *	www.implico.pl
 *
 *	Licensed under the MIT license.
 *	http://en.wikipedia.org/wiki/MIT_License
 */

(function(e){e.fn.ajaxGetContent=function(t){t=e.extend({requestParameter:"ajax_get_standard_content",baseUrl:"",useCache:true,forceBookmarkLinking:false,params:{},excludeUrl:[],excludeSelector:[],excludeAttr:{rel:"lightbox",rel:"nofollow"},onHrefCheck:function(e,t){return e.length==0||e.substr(e.length-1,1)=="/"||e.substr(e.length-5,5)==".html"},onSend:function(e){},onReceive:function(e,t){}},t);var n=!t.forceBookmarkLinking&&history.pushState;var r=new Array;var i=this;e.fn.ajaxGetContent.lastClickedElement=null;e.fn.ajaxGetContent.lastClickedUrl=null;e.fn.ajaxGetContent.ajaxHandler=null;wasClicked=e("body").data("ajaxGetContent");var s=function(n,i){if(typeof n=="boolean"){if(e.fn.ajaxGetContent.ajaxHandler){e.fn.ajaxGetContent.ajaxHandler.abort();e.fn.ajaxGetContent.ajaxHandler=null}e.fn.ajaxGetContent.lastClickedUrl=i;if(t.useCache&&i in r){t.onSend(i);s(r[i],"success");return}var o=new Array;var u=new String;if(i.indexOf("?")>=0)u=i.substr(i.indexOf("?"));var a=e.deparam(u);e.each(a,function(e,t){o.push({name:e,value:t})});var f=e.fn.ajaxGetContent.lastClickedElement;var l=f&&f.data("options")?f.data("options"):t;e.each(l.params,function(t,n){if(f.is(t))e.each(n,function(e,t){o.push({name:e,value:t})})});o.push({name:t.requestParameter,value:"on"});e.fn.ajaxGetContent.ajaxHandler=e.ajax({url:i,data:o,type:"GET",success:s,error:s,context:this});t.onSend(i)}else{e.fn.ajaxGetContent.ajaxHandler=null;if(i=="success"){if(t.useCache&&e.fn.ajaxGetContent.lastClickedUrl){r[e.fn.ajaxGetContent.lastClickedUrl]=n}}else{}t.onReceive(n,i)}};e.fn.ajaxGetContent.load=function(t){if(n){if(t==null)t=href.location;history.pushState({},"",t);wasClicked=true;e(window).trigger("popstate")}else{if(t==null)t=e.param.fragment();if(e.param.fragment()!=t)jQuery.bbq.pushState(t,2);else s(true,t)}};e.fn.ajaxGetContent.scrollTo=function(t,n){var r=e("html").scrollTop();if(!r)r=e("body").scrollTop();if(n||r>e(t).offset().top){e("html,body").animate({scrollTop:e(t).offset().top},500)}};e.fn.ajaxGetContent.getCurrentUrl=function(){if(n){var t=new String(location.href);var r=t.indexOf("//");r=r>=0?r+2:0;t=t.substr(t.indexOf("/",r));if(t.length==0)t="/";return t}else return e.param.fragment()};if(!e("body").data("ajaxGetContent")){e(window).bind(n?"popstate":"hashchange",function(e){if(!(n&&!wasClicked))s(true,n?location.href:e.fragment)});e("body").data("ajaxGetContent",true)}return this.each(function(r,i){$this=e(i);var s=$this.data("ajaxGetContent");var o=$this.attr("href");var u=new String;var a=location.href.substr(0,5)!="http:";var f=new String((a?"https://":"http://")+window.location.hostname);if(o.indexOf(f)==0)o=o.substr(f.length);if(o.indexOf("?")>=0){u=o.substr(o.indexOf("?"));o=o.substr(0,o.indexOf("?"))}var l=false;e.each(t.excludeSelector,function(e,t){if($this.is(t)){l=true;return}});var c=o.substr(0,1)!="/"||o.indexOf("#")>=0;var h=false;e.each(t.excludeUrl,function(e,t){if(o.indexOf(t)>=0){h=true;return}});var p=t.onHrefCheck(o,u);var d=false;e.each(t.excludeAttr,function(e,t){if($this.attr(e)&&$this.attr(e).indexOf(t)==0){d=true;return}});var v=$this.get(0).onclick!=null;if(!s&&!l&&!c&&!h&&p&&!d&&!v){$this.data("ajaxGetContent",true);$this.click(function(){var r=new String(window.location.href);if(r.indexOf("#")>=0)r=r.substr(0,r.indexOf("#"));if(!n){var i=t.baseUrl;if(i!=""){if(r!=i){location.href=i+"#"+o+u;return false}}}var s=e(this);s.data("options",t);e.fn.ajaxGetContent.lastClickedElement=s;wasClicked=true;if(n){history.pushState({},"",o+u);e(window).trigger("popstate")}else jQuery.bbq.pushState(o+u,2);return false})}})}})(jQuery)